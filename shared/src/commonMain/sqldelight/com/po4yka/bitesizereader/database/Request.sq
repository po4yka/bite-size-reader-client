-- Request table schema

CREATE TABLE IF NOT EXISTS Request (
    id INTEGER NOT NULL PRIMARY KEY,
    inputUrl TEXT NOT NULL,
    type TEXT NOT NULL, -- URL, YOUTUBE_VIDEO
    status TEXT NOT NULL, -- PENDING, PROCESSING, COMPLETED, ERROR, CANCELLED
    stage TEXT, -- CONTENT_EXTRACTION, LLM_SUMMARIZATION, VALIDATION, DONE
    progress INTEGER NOT NULL DEFAULT 0, -- 0-100
    langPreference TEXT NOT NULL DEFAULT 'auto',

    -- Result
    summaryId INTEGER,

    -- Error handling
    errorMessage TEXT,
    canRetry INTEGER NOT NULL DEFAULT 0,

    -- Progress estimation
    estimatedSecondsRemaining INTEGER,

    -- Timestamps (stored as ISO 8601 strings)
    createdAt TEXT NOT NULL,
    updatedAt TEXT,
    completedAt TEXT
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_request_status ON Request(status);
CREATE INDEX IF NOT EXISTS idx_request_createdAt ON Request(createdAt);
CREATE INDEX IF NOT EXISTS idx_request_summaryId ON Request(summaryId);

-- Queries

selectAll:
SELECT * FROM Request
ORDER BY createdAt DESC;

selectById:
SELECT * FROM Request
WHERE id = ?;

selectByStatus:
SELECT * FROM Request
WHERE status = ?
ORDER BY createdAt DESC;

selectPending:
SELECT * FROM Request
WHERE status IN ('PENDING', 'PROCESSING')
ORDER BY createdAt DESC;

selectRecent:
SELECT * FROM Request
ORDER BY createdAt DESC
LIMIT ?;

insert:
INSERT OR REPLACE INTO Request(
    id, inputUrl, type, status, stage, progress, langPreference,
    summaryId, errorMessage, canRetry, estimatedSecondsRemaining,
    createdAt, updatedAt, completedAt
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

updateStatus:
UPDATE Request
SET status = ?, stage = ?, progress = ?,
    estimatedSecondsRemaining = ?, updatedAt = ?
WHERE id = ?;

updateCompleted:
UPDATE Request
SET status = 'COMPLETED', summaryId = ?, completedAt = ?, updatedAt = ?
WHERE id = ?;

updateError:
UPDATE Request
SET status = 'ERROR', errorMessage = ?, canRetry = ?, updatedAt = ?
WHERE id = ?;

deleteById:
DELETE FROM Request
WHERE id = ?;

deleteCompleted:
DELETE FROM Request
WHERE status = 'COMPLETED' AND completedAt IS NOT NULL;

deleteAll:
DELETE FROM Request;
