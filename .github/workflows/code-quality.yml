name: Code Quality

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # Kotlin linting with detekt
  kotlin-lint:
    name: Kotlin Lint (Detekt)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-home-cache-cleanup: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run detekt
        run: ./gradlew detekt --no-daemon || echo "âš ï¸ Detekt not yet configured - add 'io.gitlab.arturbosch.detekt' plugin to enable"
        continue-on-error: true

      - name: Upload detekt reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-reports
          path: |
            **/build/reports/detekt/
          retention-days: 30
        continue-on-error: true

  # Dependency vulnerability scanning
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check for dependency updates
        run: ./gradlew dependencyUpdates -Drevision=release --no-daemon || echo "âš ï¸ Dependency updates plugin not configured"
        continue-on-error: true

      - name: Upload dependency update report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-updates-report
          path: build/dependencyUpdates/
          retention-days: 30
        continue-on-error: true

  # Gradle validation
  gradle-validation:
    name: Validate Gradle Wrapper
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v4

  # Check for common issues
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check for TODOs and FIXMEs
        run: |
          echo "## ðŸ“ TODOs and FIXMEs found in code:" >> $GITHUB_STEP_SUMMARY
          grep -r --include="*.kt" --include="*.kts" -n "TODO\|FIXME" . || echo "âœ… No TODOs or FIXMEs found" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Check for hardcoded secrets patterns
        run: |
          echo "## ðŸ”’ Security Check - Searching for potential hardcoded secrets:" >> $GITHUB_STEP_SUMMARY

          # Check for common secret patterns
          if grep -r --include="*.kt" --include="*.kts" --include="*.xml" -i "api[_-]key\|api[_-]secret\|password\s*=\|secret\s*=\|token\s*=" . | grep -v "// "; then
            echo "âš ï¸ Potential hardcoded secrets found! Review the files above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No obvious hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check for .gitignore compliance
        run: |
          # Check if sensitive files exist that should be ignored
          if [ -f "local.properties" ] || [ -f "*.jks" ] || [ -f "*.keystore" ]; then
            echo "âš ï¸ WARNING: Sensitive files found in repository!" >> $GITHUB_STEP_SUMMARY
            echo "These should be in .gitignore:" >> $GITHUB_STEP_SUMMARY
            ls -la local.properties *.jks *.keystore 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
          else
            echo "âœ… No sensitive files detected in repository" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  # Code metrics and statistics
  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Generate code statistics
        run: |
          echo "## ðŸ“Š Code Statistics" >> $GITHUB_STEP_SUMMARY

          # Count Kotlin files
          kt_files=$(find . -name "*.kt" | wc -l)
          echo "- Kotlin files: $kt_files" >> $GITHUB_STEP_SUMMARY

          # Count lines of code
          kt_lines=$(find . -name "*.kt" -exec cat {} \; | wc -l)
          echo "- Lines of Kotlin code: $kt_lines" >> $GITHUB_STEP_SUMMARY

          # Count test files
          test_files=$(find . -path "*/test/*" -name "*.kt" | wc -l)
          echo "- Test files: $test_files" >> $GITHUB_STEP_SUMMARY

          # Module breakdown
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Module Breakdown:" >> $GITHUB_STEP_SUMMARY
          for module in shared composeApp; do
            if [ -d "$module" ]; then
              module_kt=$(find $module -name "*.kt" | wc -l)
              module_lines=$(find $module -name "*.kt" -exec cat {} \; | wc -l)
              echo "- **$module**: $module_kt files, $module_lines lines" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check for LICENSE file
        run: |
          if [ -f "LICENSE" ] || [ -f "LICENSE.md" ] || [ -f "LICENSE.txt" ]; then
            echo "âœ… LICENSE file found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No LICENSE file found in repository root" >> $GITHUB_STEP_SUMMARY
          fi

  # Summary
  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [ kotlin-lint, dependency-scan, gradle-validation, static-analysis, code-metrics, license-check ]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸŽ¯ Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check job statuses
          if [[ "${{ needs.kotlin-lint.result }}" == "success" ]]; then
            echo "âœ… Kotlin Lint: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Kotlin Lint: ${{ needs.kotlin-lint.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.dependency-scan.result }}" == "success" ]]; then
            echo "âœ… Dependency Scan: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Dependency Scan: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.gradle-validation.result }}" == "success" ]]; then
            echo "âœ… Gradle Validation: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Gradle Validation: ${{ needs.gradle-validation.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.static-analysis.result }}" == "success" ]]; then
            echo "âœ… Static Analysis: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Static Analysis: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.code-metrics.result }}" == "success" ]]; then
            echo "âœ… Code Metrics: Generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Code Metrics: ${{ needs.code-metrics.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.license-check.result }}" == "success" ]]; then
            echo "âœ… License Check: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ License Check: ${{ needs.license-check.result }}" >> $GITHUB_STEP_SUMMARY
          fi
